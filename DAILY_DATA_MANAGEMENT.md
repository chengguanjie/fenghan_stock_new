# 按日期管理库存数据功能说明

## 功能概述

系统现在支持按日期管理库存数据，实现以下功能：

1. ✅ **自动记录上传日期**：Excel 上传时自动添加当天日期
2. ✅ **当日覆盖策略**：同一天多次上传，自动覆盖旧数据
3. ✅ **只显示当天数据**：前端用户界面只显示当天上传的数据

## 工作原理

### 1. 上传 Excel 时

当管理员上传 Excel 文件时：

```
1. 系统获取当天日期（年-月-日）
2. 删除数据库中该日期的所有旧数据
3. 导入新的 Excel 数据，并标记为当天日期
4. 返回导入结果，包含覆盖了多少条旧数据
```

### 2. 用户查看盘点数据时

当用户登录查看盘点数据时：

```
1. 系统获取当天日期
2. 只查询当天上传的物料数据
3. 显示在盘点卡片中
```

### 3. 数据库结构

在 `inventory_items` 表中新增了 `upload_date` 字段：

```sql
upload_date DATE NOT NULL  -- 上传日期（只包含年月日）
```

## 使用场景

### 场景 1：管理员多次上传

**情况**：管理员今天上午上传了 Excel，下午发现数据有误，需要重新上传。

**处理**：
- 下午上传新 Excel 时，系统自动删除上午上传的数据
- 用户看到的始终是最新的数据
- 不会出现重复或混乱的数据

### 场景 2：跨天上传

**情况**：昨天上传了 Excel，今天又上传了新的 Excel。

**处理**：
- 昨天和今天的数据分别存储，互不影响
- 用户只能看到今天上传的数据
- 昨天的数据保留在数据库中（历史记录）

### 场景 3：用户盘点

**情况**：用户登录系统进行盘点。

**处理**：
- 系统只显示当天上传的物料数据
- 保证用户看到的是最新的库存清单
- 避免盘点旧数据造成混乱

## 优势

### 1. **数据一致性**
- 同一天内，所有数据来自同一次上传
- 避免新旧数据混合导致的混乱

### 2. **简化管理**
- 管理员可以随时重新上传，无需手动删除旧数据
- 系统自动处理覆盖逻辑

### 3. **历史追溯**
- 保留历史上传记录（通过 upload_date 字段）
- 可以查询往日的数据（如需要）

### 4. **防止重复**
- 结合之前的去重机制
- Excel 内部去重 + 数据库去重
- 同一天多次上传时覆盖旧数据

## 技术实现

### 后端修改

#### 1. 数据库 Schema (prisma/schema.prisma)

```prisma
model InventoryItem {
  // ... 其他字段
  uploadDate       DateTime          @map("upload_date") @db.Date
  
  @@index([uploadDate])
}
```

#### 2. 上传逻辑 (inventory.service.ts)

```typescript
// 获取当天日期
const today = new Date();
today.setHours(0, 0, 0, 0);

// 删除当天旧数据
await prisma.inventoryItem.deleteMany({
  where: { uploadDate: today }
});

// 创建新数据，带上传日期
await prisma.inventoryItem.createMany({
  data: items.map(item => ({
    ...item,
    uploadDate: today
  }))
});
```

#### 3. 查询逻辑 (inventory.service.ts)

```typescript
// 只查询当天的数据
const items = await prisma.inventoryItem.findMany({
  where: {
    name: userName,
    uploadDate: today  // 关键过滤条件
  }
});
```

## 上传反馈信息

上传成功后会返回：

```json
{
  "success": true,
  "count": 219,
  "totalRows": 250,
  "uniqueRows": 219,
  "deletedOldItems": 150,
  "uploadDate": "2025-11-16",
  "message": "成功导入 219 条数据,已覆盖当天旧数据 150 条"
}
```

## 注意事项

### 1. **时区问题**
- 系统使用服务器时间判断"当天"
- 确保服务器时区设置正确

### 2. **凌晨切换**
- 每天 00:00 系统自动切换到新的一天
- 凌晨上传的数据属于新的一天

### 3. **历史数据**
- 旧日期的数据不会被删除
- 如需清理历史数据，需要单独处理

### 4. **用户提示**
- 用户界面可以显示当前查看的是哪一天的数据
- 如果当天没有数据，给出明确提示

## 未来优化建议

### 1. **日期选择功能**
- 允许用户查看历史某一天的数据
- 在用户界面添加日期选择器

### 2. **数据对比**
- 对比不同日期的数据变化
- 生成变更报告

### 3. **定期清理**
- 自动清理超过 N 天的历史数据
- 避免数据库膨胀

### 4. **导出时标注日期**
- 导出的 Excel 文件名包含日期
- 便于管理员存档

## 测试建议

1. **测试同一天多次上传**
   - 上传 Excel A (100条)
   - 上传 Excel B (150条)
   - 验证只有 150 条数据，且是 Excel B 的内容

2. **测试跨天上传**
   - 今天上传 Excel A
   - 明天上传 Excel B
   - 验证今天看到的是 Excel A，明天看到的是 Excel B

3. **测试用户界面**
   - 上传新数据后，用户刷新页面
   - 验证显示最新数据
   - 验证数量正确

## 总结

通过引入 `uploadDate` 字段，系统现在可以：
- ✅ 自动管理每天的数据版本
- ✅ 支持当天多次上传，自动覆盖
- ✅ 确保用户看到的是当天最新数据
- ✅ 保留历史数据供追溯

这个机制解决了之前多次上传导致数据重复的问题，简化了管理流程。
